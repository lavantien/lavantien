name: Update README

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update README with repos
        run: |
          python3 << 'EOF'
          import subprocess
          import json
          import re
          from datetime import datetime

          # Get repos with languages and descriptions
          result = subprocess.run([
              'gh', 'repo', 'list', '--limit', '300',
              '--json', 'name,stargazerCount,description,languages,isFork,isArchived'
          ], capture_output=True, text=True)

          repos = []
          lang_sizes = {}  # Track total size per language across all repos

          for item in json.loads(result.stdout):
              # Include all non-fork, non-archived repos (we'll filter by stars later)
              if not item['isFork'] and not item['isArchived']:
                  repos.append({
                      'name': item['name'],
                      'stars': item['stargazerCount'],
                      'description': item.get('description', ''),
                  })
                  # Aggregate language sizes
                  if item.get('languages'):
                      for lang in item['languages']:
                          name = lang['node']['name']
                          size = lang.get('size', 0)
                          lang_sizes[name] = lang_sizes.get(name, 0) + size

          # Languages considered "programming languages"
          PROG_LANGS = {
              'Go', 'Dart', 'C#', 'TypeScript', 'Python', 'Java', 'JavaScript',
              'C++', 'C', 'Rust', 'Swift', 'Kotlin', 'Ruby', 'PHP', 'Lua',
              'Blade', 'Svelte', 'Objective-C', 'Hack', 'Clojure', 'Scala',
              'Haskell', 'Elixir', 'Julia', 'R', 'MATLAB', 'Perl', 'F#',
          }

          # Language badge icons
          icons = {
              'Go': '![Go](https://img.shields.io/badge/Go-00ADD8?logo=go&logoColor=white&logoWidth=12)',
              'Python': '![Python](https://img.shields.io/badge/Python-3776AB?logo=python&logoColor=white&logoWidth=12)',
              'TypeScript': '![TypeScript](https://img.shields.io/badge/TS-3178C6?logo=typescript&logoColor=white&logoWidth=12)',
              'C#': '![C#](https://img.shields.io/badge/C%23-239120?logo=csharp&logoColor=white&logoWidth=12)',
              'Rust': '![Rust](https://img.shields.io/badge/Rust-000000?logo=rust&logoColor=white&logoWidth=12)',
              'C++': '![C++](https://img.shields.io/badge/C%2B%2B-00599C?logo=cpp&logoColor=white&logoWidth=12)',
              'Java': '![Java](https://img.shields.io/badge/Java-007396?logo=openjdk&logoColor=white&logoWidth=12)',
              'JavaScript': '![JavaScript](https://img.shields.io/badge/JS-F7DF1E?logo=javascript&logoColor=white&logoWidth=12)',
              'HTML': '![HTML](https://img.shields.io/badge/HTML-E34F26?logo=html5&logoColor=white&logoWidth=12)',
              'CSS': '![CSS](https://img.shields.io/badge/CSS-1572B6?logo=css3&logoColor=white&logoWidth=12)',
              'Shell': '![Shell](https://img.shields.io/badge/Shell-4EAA25?logo=gnu-bash&logoColor=white&logoWidth=12)',
              'PowerShell': '![PowerShell](https://img.shields.io/badge/PS-5391FE?logo=powershell&logoColor=white&logoWidth=12)',
              'Makefile': '![Makefile](https://img.shields.io/badge/Make-427819?logo=gnu-make&logoColor=white&logoWidth=12)',
              'Lua': '![Lua](https://img.shields.io/badge/Lua-000080?logo=lua&logoColor=white&logoWidth=12)',
              'Dart': '![Dart](https://img.shields.io/badge/Dart-0175C2?logo=dart&logoColor=white&logoWidth=12)',
              'Svelte': '![Svelte](https://img.shields.io/badge/Svelte-FF3E00?logo=svelte&logoColor=white&logoWidth=12)',
              'C': '![C](https://img.shields.io/badge/C-A8B9CC?logo=c&logoColor=white&logoWidth=12)',
              'SCSS': '![SCSS](https://img.shields.io/badge/SCSS-CC6699?logo=sass&logoColor=white&logoWidth=12)',
              'Typst': '![Typst](https://img.shields.io/badge/Typst-239DAD?logo=data:image/svg%2bxml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48dGV4dCB5PSIuOWVtIiBmb250LXNpemU9IjkwIj5UPC90ZXh0Pjwvc3ZnPg==&logoColor=white&logoWidth=12)',
              'Go Template': '![GoTemplate](https://img.shields.io/badge/GoTpl-00ADD8?logo=go&logoColor=white&logoWidth=12)',
              'PHP': '![PHP](https://img.shields.io/badge/PHP-777BB4?logo=php&logoColor=white&logoWidth=12)',
              'Swift': '![Swift](https://img.shields.io/badge/Swift-F05138?logo=swift&logoColor=white&logoWidth=12)',
              'Kotlin': '![Kotlin](https://img.shields.io/badge/Kotlin-7F52FF?logo=kotlin&logoColor=white&logoWidth=12)',
              'Ruby': '![Ruby](https://img.shields.io/badge/Ruby-CC342D?logo=ruby&logoColor=white&logoWidth=12)',
              'Blade': '![Blade](https://img.shields.io/badge/Blade-F55247?logo=laravel&logoColor=white&logoWidth=12)',
              'Vue': '![Vue](https://img.shields.io/badge/Vue-4FC08D?logo=vuedotjs&logoColor=white&logoWidth=12)',
              'Vim Script': '![Vim](https://img.shields.io/badge/Vim-019733?logo=vim&logoColor=white&logoWidth=12)',
              'TeX': '![TeX](https://img.shields.io/badge/TeX-3D6117?logo=latex&logoColor=white&logoWidth=12)',
              'CMake': '![CMake](https://img.shields.io/badge/CMake-064F8C?logo=cmake&logoColor=white&logoWidth=12)',
              'Dockerfile': '![Docker](https://img.shields.io/badge/Docker-2496ED?logo=docker&logoColor=white&logoWidth=12)',
              'Batchfile': '![Batch](https://img.shields.io/badge/Batch-4EAA25?logo=windows&logoColor=white&logoWidth=12)',
              'Nix': '![Nix](https://img.shields.io/badge/Nix-5D7997?logo=nixos&logoColor=white&logoWidth=12)',
              'TSQL': '![TSQL](https://img.shields.io/badge/TSQL-CC2927?logo=microsoftsqlserver&logoColor=white&logoWidth=12)',
              'Objective-C': '![ObjC](https://img.shields.io/badge/ObjC-4388D0?logo=objectivec&logoColor=white&logoWidth=12)',
          }

          # Get top 32 languages by total size and categorize
          top_langs = sorted(lang_sizes.items(), key=lambda x: x[1], reverse=True)[:32]

          prog_badges = []
          rest_badges = []
          for lang, size in top_langs:
              badge = icons.get(lang, f'![{lang}]')
              if lang in PROG_LANGS:
                  prog_badges.append(badge)
              else:
                  rest_badges.append(badge)

          # Two rows separated by blank line
          lang_badges = f"{' '.join(prog_badges)}\n\n{' '.join(rest_badges)}"

          def shorten_desc(desc):
              if len(desc) > 55:
                  return desc[:52] + '...'
              return desc if desc else ''

          def make_row(left, right=None):
              l_link = f'<td><a href="https://github.com/lavantien/{left["name"]}">{left["name"]}</a> ({left["stars"]}⭐)</td><td>{shorten_desc(left["description"])}</td>'
              if right:
                  r_link = f'<td><a href="https://github.com/lavantien/{right["name"]}">{right["name"]}</a> ({right["stars"]}⭐)</td><td>{shorten_desc(right["description"])}</td>'
                  return f'<tr>\n{l_link}{r_link}\n</tr>'
              return f'<tr>\n{l_link}</tr>'

          # Always include modern-swe-library first
          rows = []
          modern_swe_lib = {
              'name': 'modern-swe-library',
              'stars': 0,
              'description': 'Open knowledge library: curated resources for modern software engineering',
          }
          # Fetch actual star count
          try:
              lib_result = subprocess.run([
                  'gh', 'repo', 'view', 'lavantien/modern-swe-library',
                  '--json', 'stargazerCount', '--jq', '.stargazerCount'
              ], capture_output=True, text=True)
              modern_swe_lib['stars'] = int(lib_result.stdout.strip()) if lib_result.stdout.strip().isdigit() else 0
          except:
              modern_swe_lib['stars'] = 9
          rows.append(modern_swe_lib)

          # Pinned repos (always at top, regardless of stars)
          pinned = ['dotfiles', 'llm-tournament', 'caro-ai-pvp']

          seen = {'modern-swe-library'}

          # Pinned first (include even if below 5 stars)
          for p in pinned:
              r = next((x for x in repos if x['name'] == p), None)
              if r:
                  rows.append(r)
                  seen.add(r['name'])

          # Rest sorted by stars (5+ stars only, excluding profile repo)
          remaining = [r for r in repos if r['name'] != 'lavantien' and r['name'] not in seen and r['stars'] >= 5]
          remaining.sort(key=lambda x: x['stars'], reverse=True)
          rows.extend(remaining)

          # Read and update README
          with open('README.md', 'r') as f:
              content = f.read()

          # Generate HTML table rows
          table_rows = ['<table>']
          for i in range(0, len(rows), 2):
              if i + 1 < len(rows):
                  table_rows.append(make_row(rows[i], rows[i + 1]))
              else:
                  table_rows.append(make_row(rows[i]))
          table_rows.append('</table>')

          # Update README content
          lines = content.split('\n')
          new_lines = []
          skip = False
          replaced_headline = False
          added_table = False

          for line in lines:
              # Replace headline line with badges and resume link
              if not replaced_headline and 'Agentic Engineer' in line and ('systems' in line or 'I build' in line):
                  new_lines.append(f'Agentic Engineer .. systems/tools/agents/games .. [Typst Resume](https://gist.github.com/lavantien/c149d2f044b7ed12eb548c3792c736b1) (pic at bottom) .. {lang_badges}')
                  replaced_headline = True
                  continue

              # Skip standalone badge lines (old format)
              if line.startswith('!['):
                  continue

              # Skip old "Featured Work" title
              if 'Featured Work' in line:
                  continue

              # Replace table content
              if not added_table and line.startswith('<table>'):
                  new_lines.extend(table_rows)
                  added_table = True
                  skip = True
                  continue
              if skip:
                  # Skip until empty line or end of file
                  if line.strip() == '' or not line.startswith('<td>') and not line.startswith('<tr>'):
                      skip = False
                      new_lines.append(line)
                  continue

              # Skip old "Last updated" anywhere in file
              if '*Last updated:' in line or 'Last updated:' in line:
                  continue

              new_lines.append(line)

          # Add "Last updated" at the end
          new_lines.append(f'*Last updated: {datetime.utcnow().strftime("%Y-%m-%d")}*')

          content = '\n'.join(new_lines)

          with open('README.md', 'w') as f:
              f.write(content)
          EOF

        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Commit & Push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add README.md
          git diff --staged --quiet || git commit -m "chore: update featured repos"
          git push
