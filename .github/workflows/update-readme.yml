name: Update README

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update README with repos
        run: |
          python3 << 'EOF'
          import subprocess
          import json
          import re
          from datetime import datetime

          # Get repos with languages and descriptions
          result = subprocess.run([
              'gh', 'repo', 'list', '--limit', '300',
              '--json', 'name,stargazerCount,description,languages,isFork,isArchived'
          ], capture_output=True, text=True)

          repos = []
          lang_sizes = {}  # Track total size per language across all repos

          for item in json.loads(result.stdout):
              # Include all non-fork, non-archived repos (we'll filter by stars later)
              if not item['isFork'] and not item['isArchived']:
                  repos.append({
                      'name': item['name'],
                      'stars': item['stargazerCount'],
                      'description': item.get('description', ''),
                  })
                  # Aggregate language sizes
                  if item.get('languages'):
                      for lang in item['languages']:
                          name = lang['node']['name']
                          size = lang.get('size', 0)
                          lang_sizes[name] = lang_sizes.get(name, 0) + size

          # Language icons for top 7
          icons = {
              'Go': '![Go](https://img.shields.io/badge/Go-00ADD8?logo=go&logoColor=white&logoWidth=12)',
              'Python': '![Python](https://img.shields.io/badge/Python-3776AB?logo=python&logoColor=white&logoWidth=12)',
              'TypeScript': '![TypeScript](https://img.shields.io/badge/TS-3178C6?logo=typescript&logoColor=white&logoWidth=12)',
              'C#': '![C#](https://img.shields.io/badge/C%23-239120?logo=csharp&logoColor=white&logoWidth=12)',
              'Rust': '![Rust](https://img.shields.io/badge/Rust-000000?logo=rust&logoColor=white&logoWidth=12)',
              'C++': '![C++](https://img.shields.io/badge/C%2B%2B-00599C?logo=cpp&logoColor=white&logoWidth=12)',
              'Java': '![Java](https://img.shields.io/badge/Java-007396?logo=openjdk&logoColor=white&logoWidth=12)',
              'JavaScript': '![JavaScript](https://img.shields.io/badge/JS-F7DF1E?logo=javascript&logoColor=white&logoWidth=12)',
              'HTML': '![HTML](https://img.shields.io/badge/HTML-E34F26?logo=html5&logoColor=white&logoWidth=12)',
              'CSS': '![CSS](https://img.shields.io/badge/CSS-1572B6?logo=css3&logoColor=white&logoWidth=12)',
              'Shell': '![Shell](https://img.shields.io/badge/Shell-4EAA25?logo=gnu-bash&logoColor=white&logoWidth=12)',
              'PowerShell': '![PowerShell](https://img.shields.io/badge/PS-5391FE?logo=powershell&logoColor=white&logoWidth=12)',
              'Makefile': '![Makefile](https://img.shields.io/badge/Make-427819?logo=gnu-make&logoColor=white&logoWidth=12)',
              'Lua': '![Lua](https://img.shields.io/badge/Lua-000080?logo=lua&logoColor=white&logoWidth=12)',
              'Dart': '![Dart](https://img.shields.io/badge/Dart-0175C2?logo=dart&logoColor=white&logoWidth=12)',
              'Svelte': '![Svelte](https://img.shields.io/badge/Svelte-FF3E00?logo=svelte&logoColor=white&logoWidth=12)',
              'C': '![C](https://img.shields.io/badge/C-A8B9CC?logo=c&logoColor=white&logoWidth=12)',
          }

          # Get top 10 languages by total size
          top_langs = sorted(lang_sizes.items(), key=lambda x: x[1], reverse=True)[:10]
          lang_badges = ' '.join([icons.get(lang, lang) for lang, _ in top_langs])

          def shorten_desc(desc):
              if len(desc) > 55:
                  return desc[:52] + '...'
              return desc if desc else ''

          def make_row(r):
              n = r['name']
              d = shorten_desc(r['description'])
              return f'<a href="https://github.com/lavantien/{n}">{n}</a> - {d}'

          # Always include modern-swe-library first
          rows = []
          modern_swe_lib = {
              'name': 'modern-swe-library',
              'stars': 0,
              'description': 'Open knowledge library: curated resources for modern software engineering',
          }
          # Fetch actual star count
          try:
              lib_result = subprocess.run([
                  'gh', 'repo', 'view', 'lavantien/modern-swe-library',
                  '--json', 'stargazerCount', '--jq', '.stargazerCount'
              ], capture_output=True, text=True)
              modern_swe_lib['stars'] = int(lib_result.stdout.strip()) if lib_result.stdout.strip().isdigit() else 0
          except:
              modern_swe_lib['stars'] = 9
          rows.append(modern_swe_lib)

          # Pinned repos (always at top, regardless of stars)
          pinned = ['dotfiles', 'llm-tournament', 'caro-ai-pvp']

          seen = {'modern-swe-library'}

          # Pinned first (include even if below 5 stars)
          for p in pinned:
              r = next((x for x in repos if x['name'] == p), None)
              if r:
                  rows.append(r)
                  seen.add(r['name'])

          # Rest sorted by stars (5+ stars only, excluding profile repo)
          remaining = [r for r in repos if r['name'] != 'lavantien' and r['name'] not in seen and r['stars'] >= 5]
          remaining.sort(key=lambda x: x['stars'], reverse=True)
          rows.extend(remaining)

          # Read and update README
          with open('README.md', 'r') as f:
              content = f.read()

          # Generate 2-column table rows
          table_rows = []
          for i in range(0, len(rows), 2):
              left = make_row(rows[i])
              if i + 1 < len(rows):
                  right = make_row(rows[i + 1])
                  table_rows.append(f'{left} | {right}')
              else:
                  table_rows.append(left)

          # Update README content
          lines = content.split('\n')
          new_lines = []
          skip = False
          replaced_lang_badges = False
          added_table = False

          for line in lines:
              # Skip old "Featured Work" title
              if 'Featured Work' in line:
                  continue

              # Replace language badges line (after headline)
              if not replaced_lang_badges and line.startswith('!['):
                  new_lines.append(lang_badges)
                  replaced_lang_badges = True
                  continue

              # Replace table content
              if not added_table and line.startswith('<a href='):
                  new_lines.extend(table_rows)
                  added_table = True
                  skip = True
                  continue
              if skip:
                  # Skip until empty line or end of file
                  if line.strip() == '' or not line.startswith('<a href='):
                      skip = False
                      new_lines.append(line)
                  continue

              # Skip old "Last updated" anywhere in file
              if '*Last updated:' in line or 'Last updated:' in line:
                  continue

              new_lines.append(line)

          # Add "Last updated" at the end
          new_lines.append(f'*Last updated: {datetime.utcnow().strftime("%Y-%m-%d")}*')

          content = '\n'.join(new_lines)

          with open('README.md', 'w') as f:
              f.write(content)
          EOF

        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Commit & Push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add README.md
          git diff --staged --quiet || git commit -m "chore: update featured repos"
          git push
