name: Update README

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update README with repos
        run: |
          python3 << 'EOF'
          import subprocess
          import json
          import re
          from datetime import datetime

          # Get repos with languages and descriptions
          result = subprocess.run([
              'gh', 'repo', 'list', '--limit', '300',
              '--json', 'name,stargazerCount,description,languages,isFork,isArchived'
          ], capture_output=True, text=True)

          repos = []
          for item in json.loads(result.stdout):
              if not item['isFork'] and not item['isArchived'] and item['stargazerCount'] >= 3:
                  # Extract top 3 languages by size
                  langs = []
                  if item.get('languages'):
                      sorted_langs = sorted(item['languages'], key=lambda x: x.get('size', 0), reverse=True)
                      langs = [l['node']['name'] for l in sorted_langs[:3]]

                  repos.append({
                      'name': item['name'],
                      'stars': item['stargazerCount'],
                      'description': item.get('description', ''),
                      'languages': langs
                  })

          # Language icons
          icons = {
              'Go': '![Go](https://img.shields.io/badge/Go-00ADD8?logo=go&logoColor=white&logoWidth=12)',
              'Python': '![Py](https://img.shields.io/badge/Python-3776AB?logo=python&logoColor=white&logoWidth=12)',
              'JavaScript': '![JS](https://img.shields.io/badge/JS-F7DF1E?logo=javascript&logoColor=white&logoWidth=12)',
              'TypeScript': '![TS](https://img.shields.io/badge/TS-3178C6?logo=typescript&logoColor=white&logoWidth=12)',
              'HTML': '![HTML](https://img.shields.io/badge/HTML-E34F26?logo=html5&logoColor=white&logoWidth=12)',
              'CSS': '![CSS](https://img.shields.io/badge/CSS-1572B6?logo=css3&logoColor=white&logoWidth=12)',
              'Java': '![Java](https://img.shields.io/badge/Java-007396?logo=openjdk&logoColor=white&logoWidth=12)',
              'C#': '![C#](https://img.shields.io/badge/C%23-239120?logo=csharp&logoColor=white&logoWidth=12)',
              'C': '![C](https://img.shields.io/badge/C-A8B9CC?logo=c&logoColor=white&logoWidth=12)',
              'C++': '![C++](https://img.shields.io/badge/C%2B%2B-00599C?logo=cpp&logoColor=white&logoWidth=12)',
              'Rust': '![Rust](https://img.shields.io/badge/Rust-000000?logo=rust&logoColor=white&logoWidth=12)',
              'PowerShell': '![PS](https://img.shields.io/badge/PS-5391FE?logo=powershell&logoColor=white&logoWidth=12)',
              'Shell': '![Sh](https://img.shields.io/badge/Shell-4EAA25?logo=gnu-bash&logoColor=white&logoWidth=12)',
              'Makefile': '![Make](https://img.shields.io/badge/Make-427819?logo=gnu-make&logoColor=white&logoWidth=12)',
              'Lua': '![Lua](https://img.shields.io/badge/Lua-000080?logo=lua&logoColor=white&logoWidth=12)',
              'Dart': '![Dart](https://img.shields.io/badge/Dart-0175C2?logo=dart&logoColor=white&logoWidth=12)',
              'Svelte': '![Svelte](https://img.shields.io/badge/Svelte-FF3E00?logo=svelte&logoColor=white&logoWidth=12)',
          }

          def get_icons(langs):
              return ' '.join([icons.get(l, l) for l in langs[:3]]) if langs else 'N/A'

          def shorten_desc(desc):
              if len(desc) > 52:
                  return desc[:49] + '...'
              return desc if desc else ''

          def make_row(idx, r):
              n = r['name']
              s = r['stars']
              d = shorten_desc(r['description'])
              i = get_icons(r['languages'])
              return f"| {idx} | [{n}](https://github.com/lavantien/{n}) | {s} | {i} | {d} |"

          # Pinned and interesting
          pinned = ['dotfiles', 'llm-tournament', 'caro-ai-pvp', 'spring-angular-ecom-architecture',
                    'go-edge-mesh', 'distributed-booking-microservices']
          interesting = ['order-demo', 'go-sudoku-solver', 'go-parallel-prime-seeker', 'takeout-to-pdf',
                         'concurrent-scrapper-ftsearch', 'health-app', 'DotnetCoreAngularDemo', 'TwoWarriors',
                         'SumoBot', 'oldschool-web', 'neovim', 'go-flutter-microservices-skeleton']

          seen = set()
          rows = []

          # Pinned first
          for p in pinned:
              r = next((x for x in repos if x['name'] == p), None)
              if r:
                  rows.append(r)
                  seen.add(r['name'])

          # Interesting
          for i in interesting:
              r = next((x for x in repos if x['name'] == i), None)
              if r and r['name'] not in seen:
                  rows.append(r)
                  seen.add(r['name'])

          # Rest (excluding profile repo)
          for r in repos:
              if r['name'] != 'lavantien' and r['name'] not in seen:
                  rows.append(r)
                  seen.add(r['name'])

          # Read and update README
          with open('README.md', 'r') as f:
              content = f.read()

          # Generate table with ranking
          table_rows = [make_row(idx, r) for idx, r in enumerate(rows, 1)]

          # Find and replace table
          lines = content.split('\n')
          new_lines = []
          skip_until_empty = False
          for line in lines:
              if '| # | Project | Stars | Stack | Description |' in line:
                  new_lines.append(line)
                  new_lines.append('|---|---------|-------|-------|-------------|')
                  new_lines.extend(table_rows)
                  skip_until_empty = True
                  continue
              if skip_until_empty:
                  if line.strip() == '':
                      skip_until_empty = False
                  continue
              new_lines.append(line)

          content = '\n'.join(new_lines)
          content = re.sub(r'\*Last updated:.*\*', f'*Last updated: {datetime.utcnow().strftime("%Y-%m-%d")}*', content)

          with open('README.md', 'w') as f:
              f.write(content)
          EOF

        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit & Push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add README.md
          git diff --staged --quiet || git commit -m "chore: update featured repos"
          git push
